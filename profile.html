<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Yellow Bull</title>

   
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Bootstrap & FontAwesome -->
    <link rel="stylesheet" href="https://www.yellowbull.app/assets/css/stylesheet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }

        .whatsapp-chat {
            position: fixed;
            bottom: 30px;
            right: 10px;
            z-index: 99;
        }

        .table th {
            text-align: center !important;
            vertical-align: middle !important;
        }

        .selectMembership{
            margin-bottom: 5px;
        }



        .custom-alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #fffa90;
            /* Warna kuning */
            color: #000;
            /* Tulisan hitam */
            padding: 15px 20px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            text-align: center;
            display: none;
        }


        .table th,
        .table td {
            font-size: 15px;
            font-weight: 600;
        }


        .btn-purchase {
            background-color: #ffbc13;
            font-weight: bold;
            font-size: 15px;
            color: white;
            width: wrap-content;
            padding-inline: 40px;
        }


        .carousel-control-prev,
        .carousel-control-next {
            z-index: 10 !important;
        }

        .carousel-control-prev-icon,
        .carousel-control-next-icon {
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
        }
        .carousel-inner img {
            max-height: 80vh;
            /* ‚¨ÖÔ∏è Maksimal 80% dari tinggi layar */
            object-fit: contain;
            /* Jaga aspek rasio gambar */
        }







        @media (max-width: 767px) {
            .d-flex {
    justify-content: space-between;
  }
            .wallet_wrap {
                width: 100%;
            }

            .admin-dashboard h2 {
                font-size: 20px;
                /* Ukuran judul lebih kecil di HP */
            }

            .admin-dashboard p {
                font-size: 14px;
                /* Ukuran teks paragraf lebih kecil */
            }

            .table th,
            .table td {
                font-size: 14px;
                /* Ukuran teks di tabel lebih kecil */
            }

            .btn {
                font-size: 14px;
                /* Ukuran tombol lebih kecil */
                padding: 8px 12px;
                /* Padding tombol lebih kecil */
            }

            .modal-title {
                font-size: 18px;
                /* Ukuran teks modal lebih kecil */
            }

            .modal-body label,
            .modal-body select {
                font-size: 14px;
                /* Ukuran teks dalam modal lebih kecil */
            }


            .alert-warning {
                display: flex;
                flex-wrap: wrap;
                align-items: center;
                width: 100%;
                /* Pastikan div mengambil lebar penuh */
            }

            .alert-warning .flex-grow-1 {
                word-wrap: break-word;
                overflow-wrap: break-word;
                white-space: normal;
                max-width: 100%;
                /* Pastikan teks tidak keluar */
            }


            .btn-purchase {
                width: 100%;
            }

            .table th:nth-child(2),
            .table td:nth-child(2) {
                max-width: 150px;
                /* Batasi lebar kolom email */
                word-wrap: break-word;
                overflow-wrap: break-word;
                white-space: normal;
            }
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.2.0/exceljs.min.js"></script>

   
    <script type="module">
        import {
            auth, db, onAuthStateChanged, doc, getDoc, updateDoc, collection, Timestamp, getDocs, onSnapshot,
            sendEmailVerification, updateEmail, reauthenticateWithCredential, EmailAuthProvider, verifyBeforeUpdateEmail, logoutUser, storage, ref, uploadBytes, getDownloadURL, resetPassword
        } from "./firebase-config.js";

    
        document.getElementById("loadingScreen").style.display = "flex";

        const membershipPriceMap = {
            "4 Liters Mega Oil basic": "$188",
            "4 Liters Mega Oil": "$208",
            "5 Liters Mega Oil": "$248",
            "5 Liters Castrol Oil": "$298",
            "4 Liters Castrol Oil": "$268",
            "Towing Package": "$108",
            "None": "-"
        };

        document.addEventListener("DOMContentLoaded", function () {
            const userTable = document.getElementById("userTableBody");

            // ‚úÖ Pastikan `auth` sudah terinisialisasi sebelum menjalankan listener
            const checkAuth = setInterval(() => {
                if (auth) {
                    clearInterval(checkAuth);
                    setupAuthListener();
                }
            }, 500);

            function setupAuthListener() {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {

                        const userRef = doc(db, "Users", user.uid);
                        const docSnap = await getDoc(userRef);

                        if (docSnap.exists()) {
                            const userData = docSnap.data();
                            document.getElementById("username").innerText = userData.userName || "User";
                            document.getElementById("vehicle_no").innerText = userData.carPlate || "Not Available";
                            document.getElementById("currentEmail").innerText = user.email || "Not Available";
                            document.getElementById("editUsername").value = userData.userName || "";
                            document.getElementById("editEmail").value = user.email || "";
                            if (userData.carPlate) {
                                const carRef = doc(db, "carPlates", userData.carPlate);
                                const carSnap = await getDoc(carRef);

                                if (carSnap.exists()) {
                                    const carData = carSnap.data();
                                    document.getElementById("car_model").innerText = carData.carModel || "Not Available";
                                    document.getElementById("car_brand").innerText = carData.carBrand || "Not Available";
                                }
                            }

                            const purchaseBtn = document.querySelector(".btn-purchase");

                            onSnapshot(userRef, (docSnap) => {
                                const userData = docSnap.data();
                                updateMembershipUI(userData);  // Call UI update function with live data
                            });


                            // **Cek Role User**
                            if (userData.role === "admin") {

                                loadAdminDashboard();
                                document.getElementById("loadingScreen").style.display = "none";
                            } else {
                                document.getElementById("loadingScreen").style.display = "none";
                            }
                        } else {

                        }

                        // **Cek Email Verified**
                        if (user.emailVerified) {
                            document.getElementById("editPassword").disabled = false;
                            document.getElementById("passwordNote").innerText = "Your email is verified. You can update your password now.";
                            document.getElementById("verifyEmailBtn").style.display = "none";
                        } else {
                            document.getElementById("verifyEmailBtn").style.display = "block";
                            document.getElementById("verifyEmailBtn").addEventListener("click", async () => {
                                try {
                                    await sendEmailVerification(auth.currentUser);
                                    Swal.fire({
                                        title: "üìß Verification Email Sent!",
                                        text: "Please check your inbox.",
                                        icon: "info",
                                        background: "#fffa90",
                                        color: "#000",
                                        confirmButtonColor: "#ffcc00"
                                    });
                                } catch (error) {
                                    Swal.fire({
                                        title: "‚ùå Failed to send verification email.",
                                        text: error.message,
                                        icon: "error",
                                        background: "#ffcccc",
                                        color: "#000",
                                        confirmButtonColor: "#ff4444"
                                    });
                                }
                            });
                        }
                    } else {
                        window.location.href = "/login";
                    }
                });
            }
            function updateMembershipUI(userData) {
                const purchaseBtn = document.querySelector(".btn-purchase, .btn-success");
                if (!purchaseBtn) return;  // ‚úÖ Jika tombol tidak ditemukan, stop fungsi

                let membershipStatus = document.getElementById("membershipStatus");
                if (!membershipStatus) {
                    membershipStatus = document.createElement("p");
                    membershipStatus.id = "membershipStatus";
                    membershipStatus.style.fontWeight = "bold";
                    membershipStatus.style.marginTop = "10px";
                    purchaseBtn.parentNode.insertBefore(membershipStatus, purchaseBtn.nextSibling);
                }
                const deleteButton = document.querySelector(".deleteMembershipBtn");

                if (userData.membership && userData.membership !== "Expired") {
                    purchaseBtn.innerText = userData.membership;
                    purchaseBtn.classList.remove("btn-purchase");
                    purchaseBtn.classList.add("btn-success");
                    purchaseBtn.removeAttribute("href");
                    purchaseBtn.style.cursor = "default";

                    if (userData.membershipEnd && userData.membershipEnd.toDate) {
                        const endDate = userData.membershipEnd.toDate();
                        const formattedDate = endDate.toLocaleDateString("en-US", {
                            day: "numeric",
                            month: "long",
                            year: "numeric"
                        });
                        membershipStatus.innerText = `‚úÖ Active until ${formattedDate}`;
                    } else {
                        membershipStatus.innerText = `‚úÖ Membership active`;
                    }
                    if (deleteButton) deleteButton.style.display = "block";
                } else {
                    purchaseBtn.innerText = "Purchase Plan";
                    purchaseBtn.setAttribute("href", "/plans");
                    purchaseBtn.classList.add("btn-purchase");
                    purchaseBtn.classList.remove("btn-success");
                    purchaseBtn.style.cursor = "pointer";
                    membershipStatus.innerText = "";
                    if (deleteButton) deleteButton.style.display = "none";
                }
                
            }

            function loadAdminDashboard() {
                let header = document.getElementById("header");

                if (!header) {
                    document.body.insertAdjacentHTML("afterbegin", `
            <section id="header" class="header">
                <div class="container p-0">
                    <nav class="navbar navbar-expand-lg">
                        <a class="navbar-brand" href="/"><img src="https://www.yellowbull.app/assets/images/logo.png" class="img-fluid"></a>
                        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                            <span class="navbar-toggler-icon"><i class="fa fa-bars" aria-hidden="true"></i></span>
                        </button>
                        <div class="collapse navbar-collapse" id="navbarSupportedContent">
                            <ul class="navbar-nav ml-auto">
                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-expanded="false">
                                        My Account
                                    </a>
                                    <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                                        <a class="dropdown-item" href="/profile">Profile</a>
                                        <a class="dropdown-item" href="#" id="logoutbtn">Sign Out</a>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </nav>
                </div>
            </section>
        `);
                    header = document.getElementById("header");
                }

                if (header) {
                    header.style.display = "block";
                }

                const adminDashboardHTML = `
        <section class="admin-dashboard">
            <div class="container">
                    <h2>Admin Dashboard</h2>
                <p>Welcome, Admin!</p>
             <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
  <!-- Filter Membership Dropdown -->
  <div class="form-group mb-2 mb-md-0">
    <label for="membershipFilter">Filter Membership:</label>
    <select id="membershipFilter" class="form-control">
      <option value="All">All</option>
      <option value="4 Liters Mega Oil basic">4 Liters Mega Oil basic</option>
      <option value="4 Liters Mega Oil">4 Liters Mega Oil</option>
      <option value="5 Liters Mega Oil">5 Liters Mega Oil</option>
      <option value="4 Liters Castrol Oil">4 Liters Castrol Oil</option>
      <option value="5 Liters Castrol Oil">5 Liters Castrol Oil</option>
      <option value="Towing Package">Towing Package</option>
      <option value="Renew">Renew</option>
      <option value="Expired">Expired</option>
    </select>
  </div>

  <!-- Search Bar -->
  <div class="form-group mb-2 mb-md-0">
    <label for="searchInput">Search:</label>
    <input type="text" id="searchInput" class="form-control" placeholder="Search name or email...">
  </div>

  <!-- Buttons for Delete and Download CSV -->
  <div class="d-flex flex-column flex-md-row ">
    <!-- Delete Expired Members Button -->
    <button id="deleteExpiredBtn" class="btn btn-danger mt-3 mt-md-0 mr-md-2">Delete Expired Members</button>

    <!-- Download CSV Button -->
    <button id="downloadCSV" class="btn btn-primary mt-3 mt-md-0">Download Excel</button>
  </div>
</div>

<!-- New summary bar for count and total -->
<div class="mb-3">
  <span id="userCount">Total Users: 0</span> |
  <span id="totalPrice">Total Price: $0</span>
</div>
            
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead class="thead-dark">
                            <tr>
                           <th style="width: 15%;">Name</th>
                        <th style="width: 20%;">Email</th>
                        <th style="width: 15%;">Membership</th>
                        <th style="width: 10%;">Price</th>
                        <th style="width: 10%;">Payment Status</th>
                        <th style="width: 10%;">Payment Method</th> <!-- New column -->
                        <th style="width: 15%;">Upload Payment Proof</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Modal Preview -->
<div class="modal fade" id="previewModal" tabindex="-1" role="dialog" aria-labelledby="previewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
<h5 class="modal-title d-flex flex-column">
  <span>Payment Proof Preview</span>
  <span id="previewMeta" class="text-muted mt-1" style="font-size: 14px;"></span>
</h5>



        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <!-- Modal for selecting Payment Method -->


      <div class="modal-body">
      <div id="proofCarousel" class="carousel slide" data-ride="carousel">
  <ol class="carousel-indicators" id="carouselIndicators"></ol>
  <div class="carousel-inner" id="carouselInner"></div>
  <a class="carousel-control-prev" href="#proofCarousel" role="button" data-slide="prev">
    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
    <span class="sr-only">Previous</span>
  </a>
  <a class="carousel-control-next" href="#proofCarousel" role="button" data-slide="next">
    <span class="carousel-control-next-icon" aria-hidden="true"></span>
    <span class="sr-only">Next</span>
  </a>
</div>


      </div>
    </div>
  </div>
</div>

        <!-- Modal untuk pilih membership -->
        <div class="modal fade" id="membershipModal" tabindex="-1" role="dialog" aria-labelledby="membershipModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Select Membership</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <label for="membershipSelect">Choose Membership:</label>
                        <select id="membershipSelect" class="form-control">
                            <option value="4 Liters Mega Oil basic">4 Liters Mega Oil basic</option>
                            <option value="4 Liters Mega Oil">4 Liters Mega Oil</option>
                            <option value="5 Liters Mega Oil">5 Liters Mega Oil</option>
                            <option value="4 Liters Castrol Oil">4 Liters Castrol Oil</option>
                            <option value="5 Liters Castrol Oil">5 Liters Castrol Oil</option>
                            <option value="Towing Package">Towing Package</option>
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="saveMembership">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="paymentMethodModal" tabindex="-1" role="dialog" aria-labelledby="paymentMethodModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentMethodModalLabel">Select Payment Method</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <label for="paymentMethodSelect">Choose Payment Method:</label>
                <select id="paymentMethodSelect" class="form-control">
                    <option value="PayNow">PayNow</option>
                    <option value="Cash">Cash</option>
                    <option value="Other">Other</option>
                </select>
                <input type="text" id="paymentDescriptionInput" class="form-control payment-description" placeholder="Describe Other payment method..." style="display:none;">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="savePaymentMethodBtn">Save</button>
            </div>
        </div>
    </div>
</div>
    `;

                document.body.innerHTML = "";
                document.body.appendChild(header);
                document.body.insertAdjacentHTML("beforeend", adminDashboardHTML);

                loadAllUsers();
                setTimeout(() => {
    checkMembershipExpiration();  // Cek lagi setelah load
}, 1000);



                setTimeout(() => {
                    const logoutBtn = document.getElementById("logoutbtn");
                    if (logoutBtn) {
                        logoutBtn.addEventListener("click", (event) => {
                            event.preventDefault();
                            Swal.fire({
                                title: "Are you sure?",
                                text: "You will be logged out.",
                                icon: "warning",
                                showCancelButton: true,
                                confirmButtonColor: "#ff4444",
                                cancelButtonColor: "#ccc",
                                confirmButtonText: "Yes, log out"
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    logoutUser();
                                }
                            });
                        });
                    }
                }, 500);
            }

            let proofImages = [];

            // **Fungsi untuk menampilkan semua user (khusus admin)**
            async function loadAllUsers() {
                try {
                    const usersRef = collection(db, "Users");
                    const querySnapshot = await getDocs(usersRef);
                    let userListHTML = "";

                      proofImages = [];

                    querySnapshot.forEach((docSnap) => {
                        const user = docSnap.data();
                        if (user.role === "admin") return;
                        const userId = docSnap.id;
        const paymentMethod = docSnap.data().paymentMethod || "Not Selected";
        

                        localStorage.setItem(`userData-${docSnap.id}`, JSON.stringify({
    membershipEnd: user.membershipEnd ? user.membershipEnd.toDate() : null,
    membership: user.membership ? user.membership.toLowerCase() : null
}));
                        const membership = user.membership || "None";


                        const paymentStatus = user.paymentStatus || "Not Paid";
                        const paymentDescription = user.paymentDescription
                        const proofImage = user.proofImage
                            ? `<img src="${user.proofImage}" alt="Proof" style="width: 50px; height: 50px; cursor: pointer;">`
                            : "No Image";

                        const price = membershipPriceMap[membership] || "-";
                        updatePaymentMethodUI(userId, paymentMethod, paymentDescription);
                        userListHTML += `
                <tr id="user-${docSnap.id}" data-price="${price.replace(/[^\d]/g, '')}">
                    <td>${user.userName || "Unknown"}</td>
                    <td>${user.email || "No Email"}</td>
                    <td class="membership-actions">
                        <button class="btn btn-${membership === "Expired" ? "danger" : "info"} btn-sm selectMembership" data-userid="${docSnap.id}">
                            ${membership}
                        </button>
                        <!-- Show delete button only if membership is not expired or none -->
                        ${membership !== "Expired" && membership !== "None" ? `
                            <button class="btn btn-danger btn-sm deleteMembershipBtn" data-userid="${docSnap.id}" title="Delete Membership">
                                Delete
                            </button>` : ''}
                    </td>
                    <td>${price}</td>
                    <td>${user.paymentStatus || "Not Paid"}</td>
                    <td>
                        <button class="btn btn-info btn-sm selectPaymentMethod" data-userid="${docSnap.id}">
                            ${paymentMethod === "Not Selected" ? "Select Payment Method" : paymentMethod}
                        </button>
                        ${paymentMethod === "Other" && paymentDescription && paymentDescription.trim() !== "" 
                            ? `<p style="font-size: 12px; color: #555; margin-top: 5px;">${paymentDescription}</p>` 
                            : ''}
                    </td>
                    <td>
                        ${proofImage}
                        <input type="file" class="form-control-file uploadProof" data-userid="${docSnap.id}">
                    </td>
                </tr>
            `;
        });

                    const currentFilter = document.getElementById("membershipFilter").value;
                    const currentSearch = document.getElementById("searchInput").value;

               
                    document.getElementById("userTableBody").innerHTML = userListHTML;
                    $('#proofCarousel').carousel({
                        interval: false,
                        wrap: true
                    });
                  
                    document.getElementById("membershipFilter").value = currentFilter;
                    document.getElementById("searchInput").value = currentSearch;
                    filterTable();
                    $('#proofCarousel').carousel(0);  // Reset ke slide pertama
                    document.getElementById("membershipFilter").addEventListener("change", () => {
                        filterTable();  // Panggil langsung, tidak simpan apapun
                    });

                    document.querySelectorAll(".uploadProof").forEach(uploadProofHandler);
       // Listen for the modal to open and set default values
       document.querySelectorAll('.selectPaymentMethod').forEach(button => {
    button.addEventListener('click', async (event) => {
        const userId = event.target.dataset.userid;

        // Open the modal to select a payment method
        $('#paymentMethodModal').modal('show');

        const paymentMethodSelect = document.getElementById("paymentMethodSelect");
        const paymentDescriptionInput = document.getElementById("paymentDescriptionInput");

        // Get current payment method data from Firestore
        const userRef = doc(db, "Users", userId);
        const userSnap = await getDoc(userRef);
        const userData = userSnap.data();
        const paymentMethod = userData.paymentMethod || "PayNow";
        const paymentDescription = userData.paymentDescription || "";

        // Set the default values
        paymentMethodSelect.value = paymentMethod;
        paymentDescriptionInput.value = paymentDescription;

        // Show or hide the description input based on the payment method
        if (paymentMethod === "Other") {
            paymentDescriptionInput.style.display = "block";
        } else {
            paymentDescriptionInput.style.display = "none";
        }

        // Handle save button click
        document.getElementById('savePaymentMethodBtn').onclick = async () => {
            const selectedPaymentMethod = paymentMethodSelect.value;
            const description = selectedPaymentMethod === "Other" ? paymentDescriptionInput.value : "";

            // Save the payment method to Firestore
            await savePaymentMethodToFirestore(userId, selectedPaymentMethod, description);

            // Close the modal
            $('#paymentMethodModal').modal('hide');
        };
    });
});



async function savePaymentMethodToFirestore(userId, paymentMethod, description) {
    const userRef = doc(db, "Users", userId);
    const paymentData = {
        paymentMethod: paymentMethod,
        paymentDescription: paymentMethod === "Other" ? description : "",  // Save description only if "Other" is selected
    };

    try {
        // Save the payment method to Firestore
        await updateDoc(userRef, paymentData);

        // After saving, immediately update the UI
        updatePaymentMethodUI(userId, paymentMethod, description);  // This updates the button text and description dynamically

        // Optionally, you can show a success alert
        Swal.fire({
            title: "‚úÖ Payment Method Updated",
            text: "The payment method and description have been updated.",
            icon: "success",
            confirmButtonColor: "#44cc44"
        });

        // Clear the description input field
        document.getElementById("paymentDescriptionInput").value = "";
        document.getElementById("paymentDescriptionInput").style.display = "none"; // Hide the input field

    } catch (error) {
        console.error("Error updating payment method:", error);
        Swal.fire({
            title: "‚ùå Error",
            text: error.message,
            icon: "error",
            confirmButtonColor: "#ff4444"
        });
    }
}
document.querySelectorAll('.deleteMembershipBtn').forEach(button => {
    button.addEventListener('click', async (event) => {
        const userId = event.target.dataset.userid;

        const confirm = await Swal.fire({
            title: "Are you sure?",
            text: "You are about to delete this membership. This action cannot be undone.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#ccc",
            confirmButtonText: "Yes, delete membership",
            cancelButtonText: "Cancel"
        });

        if (!confirm.isConfirmed) {
            return;  // If the user cancels, do nothing
        }

        // Proceed with deleting the membership if confirmed
        try {
            // Update membership data in Firestore
            await updateDoc(doc(db, "Users", userId), {
                membership: "None",  // Remove membership information
                paymentStatus: "Not Paid",  // Update payment status
                membershipStart: null,  // Clear start date
                membershipEnd: null,  // Clear end date
            });

            // Update UI without removing the row
            const userRow = document.getElementById(`user-${userId}`);
            const membershipButton = userRow.querySelector('.selectMembership');
            const deleteButton = userRow.querySelector('.deleteMembershipBtn');

            // Update the membership button
            membershipButton.innerText = "None";
            membershipButton.classList.remove('btn-info');
            membershipButton.classList.add('btn-secondary');

            // Remove the delete button entirely from the DOM
            if (deleteButton) {
                deleteButton.remove();  // Remove the delete button from the DOM
            }

            Swal.fire({
                title: "‚úÖ Membership Deleted!",
                text: "The membership has been successfully deleted.",
                icon: "success",
                confirmButtonColor: "#44cc44"
            });

        } catch (error) {
            Swal.fire({
                title: "‚ùå Error",
                text: "There was an issue deleting the membership. Please try again.",
                icon: "error",
                confirmButtonColor: "#ff4444"
            });
        }
    });
});

async function updatePaymentMethodUI(userId, paymentMethod, paymentDescription) {
    const paymentButton = document.querySelector(`#user-${userId} .selectPaymentMethod`);

    if (paymentButton) {
        // Update the payment method displayed on the button
        paymentButton.innerText = paymentMethod === "Other" ? `Other` : paymentMethod;
        
        // Find the existing description paragraph
        let descriptionParagraph = document.querySelector(`#user-${userId} .payment-description`);

        // Remove any existing description
        if (descriptionParagraph) {
            descriptionParagraph.remove();
        }

        // If payment method is "Other" and there is a description, display it
        if (paymentMethod === "Other" && paymentDescription && paymentDescription.trim() !== "") {
            // Create a new description paragraph
            descriptionParagraph = document.createElement("p");
            descriptionParagraph.classList.add("payment-description");
            descriptionParagraph.style.fontSize = "12px";
            descriptionParagraph.style.color = "#555";
            descriptionParagraph.style.marginTop = "5px";
            descriptionParagraph.innerText = paymentDescription;

            // Insert the new description after the payment method button
            paymentButton.insertAdjacentElement('afterend', descriptionParagraph);
        }
    }
}

document.getElementById('downloadCSV').addEventListener('click', async function() {
    try {
        // Start loading screen (optional)

        // Get all users from Firestore
        const usersRef = collection(db, "Users");
        const querySnapshot = await getDocs(usersRef);

        let data = [];
        const headers = [
            'No.', 'Name', 'Handphone', 'Car Plate', 'Email', 'Birthday Month',
            'Insurance Expiry Month', 'Car Make', 'Car Model'
        ];

        // Add headers to data array
        data.push(headers);

        // Loop through each document (user data) and collect necessary information
        let rowNumber = 1; // Start numbering from 1
        for (const docSnap of querySnapshot.docs) {
            const user = docSnap.data();

            // Exclude users with role 'admin'
            if (user.role && user.role === "admin") {
                continue; // Skip the current iteration if the role is 'admin'
            }

            // Add a check to ensure `carPlate` exists before querying carPlates
            let carData = {};
            if (user.carPlate) {
                const carPlateRef = doc(db, "carPlates", user.carPlate);
                const carSnap = await getDoc(carPlateRef);
                carData = carSnap.exists() ? carSnap.data() : {};
            }

            const userData = [
                rowNumber++, // Increment row number for each user
                user.userName || "Unknown", // Name
                user.userContact || "Not Available", // Handphone
                user.carPlate || "Not Available", // Car Plate
                user.email || "Not Available", // Email
                user.dob || "Not Available", // Birthday Month
                user.InsExpMonth || "Not Available", // Insurance Expiry Month
                carData.carBrand || "Not Available", // Car Make
                carData.carModel || "Not Available" // Car Model
            ];

            // Add row data to the data array
            data.push(userData);
        }

        // Create a new Excel workbook
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('User Data');

        // Add columns to the worksheet with auto width for "No."
        worksheet.columns = headers.map((header, index) => ({
            header: header,
            key: header,
            width: index === 0 ? 10 : 20  // Set a smaller width for 'No.' and larger for others
        }));

        // Add rows to the worksheet
        data.slice(1).forEach(row => {
            worksheet.addRow(row);
        });

        // Style headers (set background color, bold, center text, etc.)
        worksheet.getRow(1).eachCell((cell) => {
            cell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true }; // Center the text and wrap text
            cell.font = { bold: true, size: 12 }; // Make the font bold and larger
            cell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'BEBEBE' } // Light gray background color
            };
        });

        // Apply border around the table and wrap text for all cells
        worksheet.eachRow((row) => {
            row.eachCell((cell) => {
                cell.border = {
                    top: { style: 'thin' },
                    left: { style: 'thin' },
                    bottom: { style: 'thin' },
                    right: { style: 'thin' }
                };
                cell.alignment = { wrapText: true, horizontal: 'center', vertical: 'middle' }; // Enable text wrapping and center alignment for each cell
            });
        });

        // Get the current date and time to use in the filename (local time)
        const now = new Date();
        const dateStr = now.toLocaleString('en-US', {
            weekday: 'short',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        }).replace(/[^\w\s]/g, '_'); // Format as: Weekday_YYYY_MM_DD_HH_MM_SS

        // Set up the response and filename
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

        // Create a link element to trigger the download
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `yellowbull_data_${dateStr}.xlsx`; // Filename includes date and time
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

    } catch (error) {
        console.error("Error exporting data:", error);
        Swal.fire({
            title: "‚ùå Error",
            text: "An error occurred while exporting data.",
            icon: "error",
            confirmButtonColor: "#ff4444"
        });

        // Hide loading screen (optional)
        document.getElementById("loadingScreen").style.display = "none";
    }
});

document.getElementById("paymentMethodSelect").addEventListener("change", function() {
    const paymentDescriptionInput = document.getElementById("paymentDescriptionInput");

    // Clear any previously entered description when switching payment method
    if (this.value !== "Other") {
        paymentDescriptionInput.style.display = "none"; // Hide the description input if it's not "Other"
        paymentDescriptionInput.value = "";  // Clear the previous description
    } else {
        paymentDescriptionInput.style.display = "block"; // Show the description input for "Other"
    }
});

                    function uploadProofHandler(input) {
                        input.addEventListener("change", async (e) => {
                            const file = e.target.files[0];
                            const userId = e.target.dataset.userid;

                            if (!file) return;

                            try {
                                const storageRef = ref(storage, `paymentProofs/${userId}_${file.name}`);
                                await uploadBytes(storageRef, file);

                                const downloadURL = await getDownloadURL(storageRef);

                                const uploadedAt = new Date().toISOString();  // Simpan waktu upload (ISO format)

                                await updateDoc(doc(db, "Users", userId), {
                                    proofImage: downloadURL,
                                    proofUploadedAt: uploadedAt   // ‚¨ÖÔ∏è Tambahkan ini ke Firestore
                                });

                                Swal.fire({
                                    title: "‚úÖ Upload Successful",
                                    text: "Proof of payment has been saved.",
                                    icon: "success"
                                });

                                await loadAllUsers();  // Refresh
                            } catch (err) {
                                Swal.fire("‚ùå Error", err?.message || "Unknown error occurred", "error");
                            }
                        });
                    }

                    // Tambahkan preview array
                    querySnapshot.forEach((docSnap) => {
                        const user = docSnap.data();
                        if (user.role === "admin") return;
                        if (user.proofImage) {
                            proofImages.push({
                                userId: docSnap.id,
                                userName: user.userName,
                                url: user.proofImage,
                                uploadedAt: user.proofUploadedAt || null  // Ambil waktu upload
                            });
                        }

                    });

                    document.getElementById("membershipFilter").addEventListener("change", filterTable);
                    document.getElementById("searchInput").addEventListener("input", filterTable);
                    document.getElementById("deleteExpiredBtn").addEventListener("click", deleteExpiredMembers);

                    function filterTable() {
    const filterValue = document.getElementById("membershipFilter").value.toLowerCase();
    const searchValue = document.getElementById("searchInput").value.toLowerCase();
    const rows = document.querySelectorAll("#userTableBody tr");
    checkMembershipExpiration();
    let visibleCount = 0;
    let totalPrice = 0;
    const now = new Date();
    const sevenDays = 7 * 24 * 60 * 60 * 1000;  // 7 hari dalam ms

    assignMembershipListeners();

    rows.forEach(row => {
        const name = row.querySelector("td:nth-child(1)").innerText.toLowerCase();
        const email = row.querySelector("td:nth-child(2)").innerText.toLowerCase();
        const membershipButton = row.querySelector("td:nth-child(3) button");
        const membership = membershipButton.innerText.toLowerCase();

        let showRow = false;

        if (filterValue === "all") {
            showRow = true;
        } else if (filterValue === "renew") {
            const userId = row.id.replace("user-", "");
            const userData = JSON.parse(localStorage.getItem(`userData-${userId}`));  // ‚¨ÖÔ∏è Simpan userData saat loadAllUsers
            if (userData && userData.membershipEnd && userData.membership !== "expired") {
                const endDate = new Date(userData.membershipEnd);
                const timeLeft = endDate - now;
                if (timeLeft > 0 && timeLeft <= sevenDays) {
                    showRow = true;
                }
            }
        } else {
            showRow = membership === filterValue;
        }

        const matchSearch = name.includes(searchValue) || email.includes(searchValue);

        if (showRow && matchSearch) {
            row.style.display = "";
            visibleCount++;

            const priceStr = row.getAttribute("data-price");
            const priceNum = parseFloat(priceStr);
            if (!isNaN(priceNum)) {
                totalPrice += priceNum;
            }
        } else {
            row.style.display = "none";
        }
    });

    document.getElementById("userCount").innerText = `Total Users: ${visibleCount}`;
    document.getElementById("totalPrice").innerText = `Total Price: $${totalPrice}`;
}

                    document.getElementById("membershipFilter").addEventListener("change", async () => {
                        await loadAllUsers();  // Fetch ulang data
                    });

                    async function deleteExpiredMembers() {
                        const confirm = await Swal.fire({
                            title: "Delete All Expired?",
                            text: "Are you sure you want to delete all expired members?",
                            icon: "warning",
                            showCancelButton: true,
                            confirmButtonColor: "#d33",
                            confirmButtonText: "Yes, delete all",
                            cancelButtonText: "Cancel"
                        });

                        if (!confirm.isConfirmed) return;

                        const rows = document.querySelectorAll("#userTableBody tr");

                        for (let row of rows) {
                            const membership = row.querySelector("td:nth-child(3) button").innerText;
                            if (membership === "Expired") {
                                const userId = row.id.replace("user-", "");
                                await deleteDoc(doc(db, "Users", userId));
                            }
                        }

                        Swal.fire("Deleted!", "All expired members have been deleted.", "success");
                        loadAllUsers();
                    }


                    document.querySelectorAll("img[alt='Proof']").forEach(img => {
                        img.addEventListener("click", () => {
                            const userRow = img.closest("tr");
                            const userId = userRow.id.split("user-")[1];
                            const userName = userRow.querySelector("td:first-child").innerText;
                            if (proofImages.length === 0) {
                                Swal.fire("‚ùå No payment proof available", "", "warning");
                                return;
                            }


                            document.getElementById("previewUserName").innerText = userName;

                            const clickedImageUrl = img.src;
                            const clickedIndex = proofImages.findIndex(p => p.url === clickedImageUrl);

                            const carouselInner = document.getElementById("carouselInner");
                            carouselInner.innerHTML = proofImages.map((imgObj, index) => {
                                const uploadTime = imgObj.uploadedAt
                                    ? new Date(imgObj.uploadedAt).toLocaleString()
                                    : "Unknown time";

                                return `
        <div class="carousel-item ${index === clickedIndex ? 'active' : ''}">
            <img class="d-block w-100" src="${imgObj.url}" alt="${imgObj.userName}">

        </div>
    `;
                            }).join("");


                            const carouselIndicators = document.getElementById("carouselIndicators");
                            carouselIndicators.innerHTML = proofImages.map((_, index) => `
  <li data-target="#proofCarousel" data-slide-to="${index}" ${index === clickedIndex ? 'class="active"' : ''}></li>
`).join("");


                            // Aktifkan carousel slide
                            setTimeout(() => {
                                $('#previewModal').modal('show');
                                $('#proofCarousel').carousel({
                                    interval: false,
                                    wrap: true
                                });
                                $('#proofCarousel').carousel(clickedIndex); // Geser ke gambar yg diklik
                            }, 100);
                            // Update info pertama kali
                            const updatePreviewMeta = (index) => {
                                const imgData = proofImages[index];
                                const uploadTime = imgData.uploadedAt
                                    ? new Date(imgData.uploadedAt).toLocaleString()
                                    : "Unknown time";
                                document.getElementById("previewMeta").innerText = `${imgData.userName} - ${uploadTime}`;
                            };

                            updatePreviewMeta(clickedIndex);

                            // Update info setiap slide berpindah
                            $('#proofCarousel').on('slide.bs.carousel', function (e) {
                                const nextIndex = $(e.relatedTarget).index();
                                updatePreviewMeta(nextIndex);
                            });


                        });
                    });

                    // Event listener untuk pilih membership
                    document.querySelectorAll(".selectMembership").forEach(button => {
                        button.addEventListener("click", (event) => {
                            const userId = event.target.dataset.userid;
                            openMembershipModal(userId);
                        });
                    });

                } catch (error) {

                }
            }

            $(document).on("click", "#infoIcon", function () {
                Swal.fire({
                    title: "‚ÑπÔ∏è Payment Proof Info",
                    text: "This image was uploaded as proof of payment. Please ensure it's clear and valid.",
                    icon: "info",
                    confirmButtonColor: "#007bff",
                    background: "#e0f7ff",
                    color: "#000"
                });
            });

            $(document).on("click", "img[alt='Proof']", function () {
    const imgSrc = $(this).attr("src");
    const userRow = $(this).closest("tr");
    const userId = userRow.attr("id").replace("user-", "");
    const userName = userRow.find("td:first-child").text();

    // Filter to get the latest proof image for each user
    const latestProofImagesMap = {};

    proofImages.forEach((imgObj) => {
        // Update map with the latest image for each user
        if (!latestProofImagesMap[imgObj.userId] || imgObj.uploadedAt > latestProofImagesMap[imgObj.userId].uploadedAt) {
            latestProofImagesMap[imgObj.userId] = imgObj;
        }
    });

    // Get an array of the latest proof images
    const latestProofImages = Object.values(latestProofImagesMap);

    // Find the index of the clicked image
    const clickedIndex = latestProofImages.findIndex(p => p.url === imgSrc);

    if (clickedIndex === -1) {
        Swal.fire("‚ùå Image not found in preview list", "", "error");
        return;
    }

    const carouselInner = $("#carouselInner");
    const carouselIndicators = $("#carouselIndicators");

    // Update carousel items and indicators with the latest proof images
    carouselInner.html(latestProofImages.map((imgObj, index) => `
        <div class="carousel-item ${index === clickedIndex ? 'active' : ''}">
            <img class="d-block w-100" src="${imgObj.url}" alt="${imgObj.userName}">
        </div>
    `).join(""));

    carouselIndicators.html(latestProofImages.map((_, index) => `
        <li data-target="#proofCarousel" data-slide-to="${index}" ${index === clickedIndex ? 'class="active"' : ''}></li>
    `).join(""));

    $('#previewModal').modal('show');
    $('#proofCarousel').carousel(clickedIndex);

    // Update preview metadata
    const updatePreviewMeta = (index) => {
        const imgData = latestProofImages[index];
        const uploadTime = imgData.uploadedAt
            ? new Date(imgData.uploadedAt).toLocaleString()
            : "Unknown time";
        $("#previewMeta").text(`${imgData.userName} - ${uploadTime}`);
    };

    updatePreviewMeta(clickedIndex);

    $('#proofCarousel').on('slide.bs.carousel', function (e) {
        const nextIndex = $(e.relatedTarget).index();
        updatePreviewMeta(nextIndex);
    });
});

            function openMembershipModal(userId) {
                $("#membershipModal").modal("show");

                document.getElementById("saveMembership").onclick = async function () {
                    const selectedMembership = document.getElementById("membershipSelect").value;
                    const startDate = new Date();
                    const endDate = new Date();
                    endDate.setFullYear(startDate.getFullYear() + 1);  // üî• Membership berlaku selama 1 tahun

                    const selectedPrice = membershipPriceMap[selectedMembership];

                    await updateDoc(doc(db, "Users", userId), {
                        membership: selectedMembership,
                        paymentStatus: "Done",
                        membershipPrice: selectedPrice,
                        membershipStart: Timestamp.fromDate(startDate),
                        membershipEnd: Timestamp.fromDate(endDate),
                    });

                    $("#membershipModal").modal("hide");
                    loadAllUsers();
                };
            }
            // Fungsi untuk assign ulang listener setiap kali tombol membership di-reload
function assignMembershipListeners() {
    document.querySelectorAll(".selectMembership").forEach(button => {
        button.onclick = (event) => {
            const userId = event.target.dataset.userid;
            openMembershipModal(userId);
        };
    });
}


            function listenForMembershipUpdates() {
                const usersRef = collection(db, "Users");

                // üî• Gunakan Firestore `onSnapshot()` untuk pemantauan real-time
                onSnapshot(usersRef, (querySnapshot) => {
                    querySnapshot.forEach((docSnap) => {
                        const userData = docSnap.data();
                        const userId = docSnap.id;
                        const membershipStatus = userData.membership || "None";
                        const membershipEnd = userData.membershipEnd ? userData.membershipEnd.toDate() : null;

                      


                        const paymentMethod = user.paymentMethod || "PayNow";
    const paymentDescription = user.paymentDescription || "";
    updatePaymentMethodUI(userId, paymentMethod, paymentDescription);
    const paymentMethodSelect = document.querySelector(`.payment-method[data-userid="${userId}"]`);
    const paymentDescriptionInput = document.querySelector(`.payment-description[data-userid="${userId}"]`);

    if (paymentMethodSelect) {
        paymentMethodSelect.value = paymentMethod;
    }

    if (paymentMethod === "Other" && paymentDescriptionInput) {
        paymentDescriptionInput.value = paymentDescription;
    }

                        const userRow = document.getElementById(`user-${userId}`);
                        if (!userRow) return;

                        const membershipActions = userRow.querySelector(".membership-actions");
                        if (!membershipActions) return;

                        if (membershipStatus === "Expired") {
                            membershipActions.innerHTML = `
    <button class="btn btn-${membershipStatus === "Expired" ? "danger" : "info"} btn-sm selectMembership" data-userid="${userId}">
        ${membershipStatus}
    </button>
`;
assignMembershipListeners();

                        } else {
                            membershipActions.innerHTML = `
                    <button class="btn btn-info btn-sm selectMembership" data-userid="${userId}">
                        ${membershipStatus}
                    </button>
                `;
                        }

                        // üî• Jika membership kurang dari 2 menit, munculkan tombol Renew
                        if (membershipEnd) {
                            const now = new Date();
                            const timeLeft = membershipEnd - now;
                            const sevenDays = 7 * 24 * 60 * 60 * 1000;  // 7 hari dalam ms

                            if (timeLeft <= 0) {
                                updateDoc(doc(db, "Users", userId), {
                                    membership: "Expired",
                                    paymentStatus: "Not Paid",
                                });
                            } else if (timeLeft <= sevenDays) {

                                showRenewButton(userId);
                            }
                        }
                    });
                });
            }

            // üî• Jalankan pemantauan real-time saat halaman dimuat
            document.addEventListener("DOMContentLoaded", async () => {
                listenForMembershipUpdates();
            });



            async function renewMembership(userId) {
    const confirm = await Swal.fire({
        title: "Are you sure?",
        text: "You are about to renew the membership for another year.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#44cc44",
        cancelButtonColor: "#ccc",
        confirmButtonText: "Yes, renew membership",
        cancelButtonText: "Cancel"
    });

    if (!confirm.isConfirmed) {
        return;  // If the user cancels, do nothing
    }

    // Proceed with renewal if confirmed
    const startDate = new Date();
    const endDate = new Date();
    endDate.setFullYear(startDate.getFullYear() + 1);  // üî• Membership berlaku selama 1 tahun

    try {
        await updateDoc(doc(db, "Users", userId), {
            membershipEnd: Timestamp.fromDate(endDate),
            paymentStatus: "Done",
        });

        Swal.fire({
            title: "‚úÖ Membership Renewed!",
            text: "Your membership has been extended for another year.",
            icon: "success",
            confirmButtonColor: "#44cc44"
        });

        removeRenewButton(userId);
        checkMembershipExpiration();
    } catch (error) {
        Swal.fire({
            title: "‚ùå Error",
            text: "There was an issue renewing the membership. Please try again.",
            icon: "error",
            confirmButtonColor: "#ff4444"
        });
    }
}

            // üîπ Function to remove the "Renew" button after clicking it
            function removeRenewButton(userId) {
                const userRow = document.getElementById(`user-${userId}`);
                if (!userRow) return;

                const membershipActions = userRow.querySelector(".membership-actions");
                if (!membershipActions) return;

                const renewButton = membershipActions.querySelector(".renew-btn");
                if (renewButton) {
                    renewButton.remove();
                }
            }

            // **Cek setiap 1 menit apakah ada membership yang expired**
            setInterval(async () => {
                await checkMembershipExpiration();
            }, 60 * 1000);
            async function checkMembershipExpiration() {

                const usersRef = collection(db, "Users");
                const querySnapshot = await getDocs(usersRef);
                const now = new Date();

                querySnapshot.forEach(async (docSnap) => {
                    const userData = docSnap.data();
                    const userId = docSnap.id;

                    if (userData.membershipEnd && userData.membershipEnd.toDate) {
                        const membershipEndDate = userData.membershipEnd.toDate();
                        const timeLeft = membershipEndDate - now;
                        const oneWeek = 7 * 24 * 60 * 60 * 1000;  // üî• 1 minggu dalam milidetik
                        if (timeLeft <= 0) {

                            await updateDoc(doc(db, "Users", userId), {
                                membership: "Expired",
                                paymentStatus: "Not Paid",
                            });

                            listenForMembershipUpdates();
                        } else if (timeLeft <= oneWeek) {
                            showRenewButton(userId);
                        }
                    }
                });

                setTimeout(checkMembershipExpiration, 60 * 1000);
            }

            // üîπ Function to show the renew button
            function showRenewButton(userId) {
                const userRow = document.getElementById(`user-${userId}`);
                if (!userRow) return;

                const membershipActions = userRow.querySelector(".membership-actions");
                if (!membershipActions) return;

                if (!membershipActions.querySelector(".renew-btn")) {
                    const renewButton = document.createElement("button");
                    renewButton.classList.add("btn", "btn-warning", "btn-sm", "renew-btn");
                    renewButton.innerText = "Renew";
                    renewButton.onclick = () => renewMembership(userId);

                    membershipActions.appendChild(renewButton);
                }
            }

            // üîÑ Run this check every 1 minute
            setInterval(async () => {
                await checkMembershipExpiration();
            }, 60 * 1000);

            document.addEventListener("DOMContentLoaded", async () => {
                await checkMembershipExpiration();
                if (document.getElementById("userTableBody")) {
                    await loadAllUsers();
                }
            });

            const resetPasswordBtn = document.getElementById("resetPasswordBtn");

resetPasswordBtn.addEventListener("click", async () => {
    const user = auth.currentUser;  // Get the currently logged in user

    if (user) {
        try {
            // Send a password reset email to the user
            await resetPassword(user.email);
            
            // Show success message
            Swal.fire({
                title: "‚úÖ Reset Password Email Sent!",
                text: "Please check your inbox to reset your password.",
                icon: "info",
                background: "#fffa90",
                color: "#000",
                confirmButtonColor: "#ffcc00"
            });
        } catch (error) {
            // Handle errors
            Swal.fire({
                title: "‚ùå Failed to Send Reset Password Email",
                text: error.message,
                icon: "error",
                background: "#ffcccc",
                color: "#000",
                confirmButtonColor: "#ff4444"
            });
        }
    } else {
        // User not logged in
        Swal.fire({
            title: "‚ùå Not Logged In",
            text: "Please log in to reset your password.",
            icon: "warning",
            confirmButtonColor: "#ff4444"
        });
    }
});

            // ‚úÖ Pastikan `editProfileForm` sudah ada sebelum menambahkan event listener
            const checkEditForm = setInterval(() => {
                const editForm = document.getElementById("editProfileForm");

                if (editForm) {
                    clearInterval(checkEditForm);

                    editForm.addEventListener("submit", async (event) => {
                        event.preventDefault();
                        const user = auth.currentUser;
                        if (!user) return;

                        const newUsername = document.getElementById("editUsername").value;
                        const newEmail = document.getElementById("editEmail").value.trim();
                        const currentEmail = user.email;

                        const userRef = doc(db, "Users", user.uid);

                        try {
                            const updateData = { userName: newUsername };

                            if (newEmail && newEmail !== currentEmail) {
                                const password = prompt("üîí Please enter your password to confirm email update:");
                                if (!password) {
                                    return Swal.fire({
                                        title: "‚ùå Email update cancelled.",
                                        icon: "error",
                                        background: "#ffcccc",
                                        color: "#000",
                                        confirmButtonColor: "#ff4444"
                                    });
                                }

                                const credential = EmailAuthProvider.credential(user.email, password);
                                await reauthenticateWithCredential(user, credential);
                                await verifyBeforeUpdateEmail(user, newEmail);
                                Swal.fire({
                                    title: "üìß A verification email has been sent!",
                                    text: "Please verify it before logging in again.",
                                    icon: "info",
                                    background: "#fffa90",
                                    color: "#000",
                                    confirmButtonColor: "#ffcc00"
                                });

                                await updateDoc(userRef, { pendingEmail: newEmail });

                                logoutUser();
                                return;
                            }

                            await updateDoc(userRef, updateData);

                            document.getElementById("username").innerText = newUsername || "User";
                            Swal.fire({
                                title: "‚úÖ Profile updated successfully!",
                                icon: "success",
                                background: "#ccffcc",
                                color: "#000",
                                confirmButtonColor: "#44cc44"
                            });

                            $('#editProfileModal').modal('hide');
                        } catch (error) {
                            Swal.fire({
                                title: "‚ùå Failed to update profile.",
                                text: error.message,
                                icon: "error",
                                background: "#ffcccc",
                                color: "#000",
                                confirmButtonColor: "#ff4444"
                            });
                        }
                    });
                } else {

                }
            }, 500);

            // ‚úÖ Pastikan logoutBtn sudah ada sebelum menambahkan event listener
            const checkLogoutBtn = setInterval(() => {
                const logoutBtn = document.getElementById("logoutbtn");

                if (logoutBtn) {
                    clearInterval(checkLogoutBtn);

                    logoutBtn.addEventListener("click", (event) => {
                        event.preventDefault();
                        Swal.fire({
                            title: "Are you sure?",
                            text: "You will be logged out.",
                            icon: "warning",
                            showCancelButton: true,
                            confirmButtonColor: "#ff4444",
                            cancelButtonColor: "#ccc",
                            confirmButtonText: "Yes, log out"
                        }).then((result) => {
                            if (result.isConfirmed) {
                                logoutUser();
                            }
                        });
                    });
                } else {
                }
            }, 500);

            const checklogoutBtn = setInterval(() => {
                const logoutBtn = document.getElementById("logoutBtn");

                if (logoutBtn) {
                    clearInterval(checkLogoutBtn);

                    logoutBtn.addEventListener("click", (event) => {
                        event.preventDefault();
                        Swal.fire({
                            title: "Are you sure?",
                            text: "You will be logged out.",
                            icon: "warning",
                            showCancelButton: true,
                            confirmButtonColor: "#ff4444",
                            cancelButtonColor: "#ccc",
                            confirmButtonText: "Yes, log out"
                        }).then((result) => {
                            if (result.isConfirmed) {
                                logoutUser();
                            }
                        });
                    });
                } else {

                }
            }, 500);

        });
    </script>


</head>

<body>
    <!-- üîÑ Loading Screen -->
    <div id="loadingScreen" style="
position: fixed;
width: 100%;
height: 100%;
background: #ffbc13;
display: flex;
justify-content: center;
align-items: center;
font-size: 24px;
font-weight: bold;
color: #333;
z-index: 9999;">
        Loading...
    </div>

    <!-- Header untuk Admin -->
    <section class="header" id="header" style="display: none;">
        <div class="container p-0">
            <nav class="navbar navbar-expand-lg">
                <a class="navbar-brand" href="/"><img src="https://www.yellowbull.app/assets/images/logo.png"
                        class="img-fluid"></a>
                <button class="navbar-toggler" type="button" data-toggle="collapse"
                    data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                    aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"><i class="fa fa-bars" aria-hidden="true"></i></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav ml-auto">
                        <!--<li class="nav-item active">-->
                        <!--<a class="nav-link" href="" style="font-size:16px">Dashboard</a>-->
                        <!--</li>-->
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                                data-toggle="dropdown" aria-expanded="false" style="font-size:16px">
                                My Account
                            </a>
                            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                                <a class="dropdown-item" href="/profile" style="font-size:16px">Profile</a>


                                <a class="dropdown-item" href="#" id="logoutbtn" style="font-size:16px">Sign Out</a>

                            </div>
                        </li>
                    </ul>
                </div>
            </nav>
        </div>


    </section>

    <section class="header">
        <div class="container p-0">
            <nav class="navbar navbar-expand-lg">
                <a class="navbar-brand" href="/"><img src="https://www.yellowbull.app/assets/images/logo.png"
                        class="img-fluid"></a>
                <button class="navbar-toggler" type="button" data-toggle="collapse"
                    data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                    aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"><i class="fa fa-bars" aria-hidden="true"></i></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav ml-auto">
                        <!--<li class="nav-item active">-->
                        <!--<a class="nav-link" href="" style="font-size:16px">Dashboard</a>-->
                        <!--</li>-->
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                                data-toggle="dropdown" aria-expanded="false" style="font-size:16px">
                                My Account
                            </a>
                            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                                <a class="dropdown-item" href="/profile" style="font-size:16px">Profile</a>

                                <a class="dropdown-item" href="/my_cart" style="font-size:16px">My Cart</a>


                                <a class="dropdown-item" href="#" id="logoutBtn" style="font-size:16px">Sign Out</a>

                            </div>
                        </li>
                    </ul>
                </div>
            </nav>
        </div>


        <div class="whatsapp-chat">
            <div style="display:flex;justify-content:center;align-items:center; ">
                <p class="ht-ctc-cta  ht-ctc-cta-hover "
                    style="padding: 0px 16px; background-color: rgb(37, 211, 102); color: rgb(255, 255, 255); border-radius: 10px; margin: 0px 10px; order: 0; display: none;">
                    WhatsApp us</p>
                <a href="https://wa.me/+6591013232/?text=yellowbull" target="_blank" class="ht_ctc_padding"
                    style="background-color: #25D366; padding: 14px; border-radius: 50%; box-shadow: 0px 0px 11px rgba(0,0,0,.5);">
                    <svg style="pointer-events:none; display:block; height:40px; width:40px;" width="40px" height="40px"
                        viewBox="0 0 1219.547 1225.016">
                        <path fill="#E0E0E0"
                            d="M1041.858 178.02C927.206 63.289 774.753.07 612.325 0 277.617 0 5.232 272.298 5.098 606.991c-.039 106.986 27.915 211.42 81.048 303.476L0 1225.016l321.898-84.406c88.689 48.368 188.547 73.855 290.166 73.896h.258.003c334.654 0 607.08-272.346 607.222-607.023.056-162.208-63.052-314.724-177.689-429.463zm-429.533 933.963h-.197c-90.578-.048-179.402-24.366-256.878-70.339l-18.438-10.93-191.021 50.083 51-186.176-12.013-19.087c-50.525-80.336-77.198-173.175-77.16-268.504.111-278.186 226.507-504.503 504.898-504.503 134.812.056 261.519 52.604 356.814 147.965 95.289 95.36 147.728 222.128 147.688 356.948-.118 278.195-226.522 504.543-504.693 504.543z">
                        </path>
                        <linearGradient id="htwaicona-chat" gradientUnits="userSpaceOnUse" x1="609.77" y1="1190.114"
                            x2="609.77" y2="21.084">
                            <stop offset="0" stop-color="#25D366"></stop>
                            <stop offset="1" stop-color="#25D366"></stop>
                        </linearGradient>
                        <path fill="url(#htwaicona-chat)"
                            d="M27.875 1190.114l82.211-300.18c-50.719-87.852-77.391-187.523-77.359-289.602.133-319.398 260.078-579.25 579.469-579.25 155.016.07 300.508 60.398 409.898 169.891 109.414 109.492 169.633 255.031 169.57 409.812-.133 319.406-260.094 579.281-579.445 579.281-.023 0 .016 0 0 0h-.258c-96.977-.031-192.266-24.375-276.898-70.5l-307.188 80.548z">
                        </path>
                        <image overflow="visible" opacity=".08" width="682" height="639"
                            transform="translate(270.984 291.372)"></image>
                        <path fill-rule="evenodd" clip-rule="evenodd" fill="#FFF"
                            d="M462.273 349.294c-11.234-24.977-23.062-25.477-33.75-25.914-8.742-.375-18.75-.352-28.742-.352-10 0-26.25 3.758-39.992 18.766-13.75 15.008-52.5 51.289-52.5 125.078 0 73.797 53.75 145.102 61.242 155.117 7.5 10 103.758 166.266 256.203 226.383 126.695 49.961 152.477 40.023 179.977 37.523s88.734-36.273 101.234-71.297c12.5-35.016 12.5-65.031 8.75-71.305-3.75-6.25-13.75-10-28.75-17.5s-88.734-43.789-102.484-48.789-23.75-7.5-33.75 7.516c-10 15-38.727 48.773-47.477 58.773-8.75 10.023-17.5 11.273-32.5 3.773-15-7.523-63.305-23.344-120.609-74.438-44.586-39.75-74.688-88.844-83.438-103.859-8.75-15-.938-23.125 6.586-30.602 6.734-6.719 15-17.508 22.5-26.266 7.484-8.758 9.984-15.008 14.984-25.008 5-10.016 2.5-18.773-1.25-26.273s-32.898-81.67-46.234-111.326z">
                        </path>
                        <path fill="#FFF"
                            d="M1036.898 176.091C923.562 62.677 772.859.185 612.297.114 281.43.114 12.172 269.286 12.039 600.137 12 705.896 39.633 809.13 92.156 900.13L7 1211.067l318.203-83.438c87.672 47.812 186.383 73.008 286.836 73.047h.255.003c330.812 0 600.109-269.219 600.25-600.055.055-160.343-62.328-311.108-175.649-424.53zm-424.601 923.242h-.195c-89.539-.047-177.344-24.086-253.93-69.531l-18.227-10.805-188.828 49.508 50.414-184.039-11.875-18.867c-49.945-79.414-76.312-171.188-76.273-265.422.109-274.992 223.906-498.711 499.102-498.711 133.266.055 258.516 52 352.719 146.266 94.195 94.266 146.031 219.578 145.992 352.852-.118 274.999-223.923 498.749-498.899 498.749z">
                        </path>
                    </svg>
                </a>
            </div>
        </div>
    </section>

    <section class="wallet_wrap">
        <div class="container">
            <div class="row">
                <div class="wallet_head">
                    <h4 style="font-weight:600">Hi, <span id="username">Loading...</span></h4>
                </div>
            </div>

            <table class="table table-borderless table-responsive-sm" style="border-top:1px solid lightgrey">
                <tbody>
                    <tr>
                        <td><b>Car Model</b></td>
                        <td><b>Vehicle Number</b></td>
                    </tr>
                    <tr>
                        <td><span id="car_model">Loading...</span></td>
                        <td><span id="vehicle_no">Loading...</span></td>
                    </tr>
                    <tr>
                        <td><b>Car Brand</b></td>
                        <td><b>Personal Information</b></td>
                    </tr>
                    <tr>
                        <td><span id="car_brand">Loading...</span></td>
                        <td>
                            <div class="alert alert-warning p-2 mb-0 d-flex flex-wrap align-items-center" role="alert">
                                <div class="flex-grow-1 text-break">
                                    <span id="currentEmail">Loading...</span>
                                </div>
                                <button class="btn btn-dark btn-sm ml-2 mt-1 mt-sm-0" data-toggle="modal"
                                    data-target="#editProfileModal">
                                    Edit
                                </button>
                            </div>
                        </td>
                    </tr>

                </tbody>
            </table>


            <a href="/plans" class="btn btn-purchase">Purchase Plan</a>
        </div>

        <div class="modal fade" id="editProfileModal" tabindex="-1" role="dialog"
        aria-labelledby="editProfileModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editProfileModalLabel">Edit Personal Information</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm">
                        <div class="form-group">
                            <label for="editUsername">Full Name</label>
                            <input type="text" id="editUsername" class="form-control">
                        </div>
    
                        <div class="form-group">
                            <label for="editEmail">Email</label>
                            <input type="email" id="editEmail" class="form-control">
                        </div>
                        <div class="form-group d-flex justify-content-start">
                            <!-- Reset Password Button -->
                            <button type="button" id="resetPasswordBtn" class="btn btn-danger" style="margin-right:10px;">Reset Password</button>
                
                            <!-- Update Profile Button -->
                            <button type="submit" class="btn btn-primary">Update Profile</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    </section>

    <script>
        $(document).ready(function () {
            $('.carousel-control-prev').on('click', () => {
            });
            $('.carousel-control-next').on('click', () => {
            });
        });
    </script>



</body>

</html>